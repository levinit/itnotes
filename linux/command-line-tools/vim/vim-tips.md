[toc]

`vimtutor` 交互式vim教学



# VIM“语法”

vim的一些操作可以从自然语言角度理解，将一个操作指令拆分成多个部分，这些部分通常可以归类成：

- verb  动词 -- 动作

  - `d` 删除行(delete）
  - `x`  删除字符
  - `r` 替换（replace）
  - `*`  搜索 (search) *光标当前所在的单词*
  - `.`  重复 (repeat) 上一次操作

  等等……

- 介词   -- modifier  修饰语，一般是对操作对象的位置进行描述

  - `i`  在...之内（inside）
  - `a`  环绕...（around）
  - `t`  到...位置前（to）
  - `f`  到...位置上（forward）
  - `0`  到行首

  等等……

- 名词 -- text object  文本对象，即动作要

  - `w`  单词（word）
  - `s`  句子（sentence）
  - `b`  块 （block/parentheses）
  - `p`  段落（paragraph）
  - `t`  标签（tag， HTML/XML标签）

  等等……

  

- 数词

  一个正整数N，表示重复操作N次，置于动词前

  

- 副词

  置于动词前，例如screen line移动相关的命令`gj`



组成VIM语句，示例：

- `diw`：delete inside word
-  `ci"`：change inside double quote
- `vas`：visual around sentense
- `9j`：repeate 9 times `j`



# 打开及保存

- 保存
  - 命令行模式下，w保存，q退出
    - `:w`  保存
    - `:wq` 保存并退出
    - `:!wq`  不保存退出
  - normal模式
    - `ZZ`  保存并退出，同命令模式`:wq`（注意是大写，因此是按住<kbd>Shift</kbd> 然后按下两次`z`）
    - `ZQ`  不保存并退出，同命令模式`:!wq`（同上，大写）



- 创建当前文件的所有上层目录  `:!mkdir -p %h`

  vim打开文件（也可能是新建文件）时，输入了不正确的路径，可以先用以上命令创建文件夹，保存退出后再移动文件到正确的位置。

- 普通用户编辑时临时启用sudo保存文件`:!w sudo tee %`

  `%`是vim当中一个只读寄存器的名字，该寄存器总保存着当前编辑文件的文件路径。
  
- vim差异化对比工具`vimdiff`：`vimdiff <file1> <file2>`



## buffer  文件缓冲区

打开一个文件后内容加载到一个缓冲区中

- `:ls`  列出当前缓冲区
- 从缓冲区重新载入`:e`
  - `:e {filename}`  打开一个新的文件
    - 放弃当前更改从缓冲区重新载入`:!e`
  - 切换到指定缓冲区
    - `:b n` 跳到第n个缓冲区（从1开始编号）
    - `:b 缓冲区名字`  可以使用<kbd>Tab</kbd>补全缓冲区名字
    - `:bp`或`:bprevious` 和`:bl`或`:blast`  上一个或下一个缓冲区



## window  窗口

一个缓冲区可以分隔为多个窗口，每个窗口可以切换不同缓冲区。

窗口操作如果使用快捷键，均以<kbd>Ctrl</kbd><kbd>w</kbd>为前缀，其后按下其他操作按键，以下以`<c-w>` 代指<kbd>Ctrl</kbd><kbd>w</kbd>。

- 分割
  - 水平`<c-w>` `s` 或`:sp`
  - 垂直`<c-w>` `v`或`:vs`

  ```shell
  #分割并打开新的文件
  :sp filename  #左右分隔且打开一个新文件
  :vsp filename #上下分隔且打开一个新文件
  ```
  
- 切换
  - `<c-w>` `w`  窗口间循环切换
  - `<c-w>` `h `/ `j` / `k` / `l`  上/下/左/右切换窗口
  
- 移动
  - `<c-w>`  `H`  / `J` / `K` / `L` 上/下/左/右移动窗口
  - `<c-w> T`  移动当前窗口到一个新的标签页
  
- 调整

  调整窗口行列数量，即高和宽。

  - 所有窗口等宽 `=`

  - 最大化活动窗口 `_`

  - 设置活动窗口行列数

    先输入一个数字，然后按下<kbd>Ctrl</kbd><kbd>w</kbd>，再按下：

    - 设置行  `_`
    - 设置列 `|`

    例如设置窗口高度为10行：先按下<kbd>1</kbd> <kbd>0</kbd>（即10），然后按下<kbd>Ctrl</kbd><kbd>w</kbd> ，最后按下<kbd>Shift</kbd><kbd>-</kbd>（即_）。

- 关闭

  - 关闭活动窗口 `c`
  - 仅保留活动窗口，关闭其他窗口 `o`



## TAB 标签页

用来组织多个窗口。

- 打开（创建）

  - 新标签页中打开文件  `:tabe[dit] {filename}`或`tabenew {filename}` 

    如果没有输入文件名则新建一个文件并打开。

  - 移动窗口到新标签页 T

    先按下窗口管理前缀键，再按下T（即<kbd>Shift</kbd><kbd>t</kbd>）。

- 切换
  - 切换到临近标签页
    - 下一个 `:tabn[ext]` 或 `gt`
    - 上一个  `:tabp[revious]` 或 `gT`
  - 切换到编号为n的标签页 `:tabn {n}`   或`{N}gt` 

- 移动

  - `:tabmove [N]`  N为一个自然数，0表示移动到最前，省略N表示移动到最后。

  - 如果vim支持鼠标或使用gvim，可以使用鼠标拖拽。

- 关闭

  - 关闭当前标签页及其中的窗口  `:tabc[close]`
  - 关闭除了活动标签页之外的所有标签页 `:tabo[nly]`  

  

# 折叠和展开

- `zo`  展开 `zc`  折叠
- `zn`  全部展开 `zN`  全部折叠



# 光标移动

## 单词间移动

大小写按键的区别，小写以非空白符号为单词分隔符（IFS），大写以空白符为单词分隔符。

- `w` `W`  移动到前一单词开头的字符
- `b` `B`  移动到后一单词开头的字符
- `ge`  移动到前一个单词尾的字符
- `e` `E`  移动到后一单词结尾的字符



## 行内移动

- `h` `l`  移动到 左 右 字符上

  数字 n+ 左右按键：光标移动到第n个字符上

  

- 行首或行尾

  - `0`  移动到行首字符上
  - `$`  移动到行尾字符上
  - `^`  移动本行第一个非空白字符上（如果第一字符是空白字符，可使用`0` `w`实现`^`效果）
  - `g_`  移动到本行最后一个非空白字符上

  

- 搜索字符并移动

  大写的按键的移动方向于小写按键相反（反向搜索匹配并移动）

  - `f{char}`  移动到匹配的字符char上（f--`find`搜索{char}字符并移动光标到第一个匹配的字符）
  - `F{char}`
  - `t{char}` 移动到匹配字符的前一个字符上（t可助记为`until`）
  - `T{char}`

  例如一行内容为`aaaaxbbbyx`，执行`fx`光标将移动到字符`x`上，执行`fy`光标移动到y前面的字符`b`上。



## 行间移动

- `j` `k`  上下移动

  数字N + 上下按键：光标移动N行

- `gg`  移动到第一行开始位置

-  `G`   移动到最后一行开始位置

- 移动到指定行

  - 数字N+`G` (<kbd>Shift</kbd><kbd>g</kbd> ) 移动到第N行的开始位置，如`10G`
  - `:n`  移动到第n行
  - `:+10`  下移10行
  - `:-10`  上移10行

- 按屏幕滚动行

  滚动行数足一行按一行算，滚动后，光标始终在行首。

  - 半屏幕

    光标在屏幕中的位置不变，除非前后行数不够（例如半屏有10行，而当前在第9行，再向上滚动光标就只能到屏幕中第一行的行首）。

    - <kbd>Ctrl</kbd> <kbd>d</kbd>  下翻半屏幕(downward) 
    - <kbd>Ctrl</kbd> <kbd>u</kbd>  上翻半屏幕(upward) 

  - 全屏幕

    - <kbd>Ctrl</kbd> <kbd>f</kbd>  下翻1屏幕(forward) ，光标会移动到屏幕中的第一行
    - <kbd>Ctrl</kbd> <kbd>b</kbd>  上翻1屏幕(backward) ，光标会移动到屏幕中的最后一行




## 屏幕行screen line移动

前文中的行是指实际的文本行，屏幕行则是在屏幕中展示为一行的行，一个文本行过长是会折行成多个屏幕行。

> ```shell
>  16 # Network information
>  17 network  --bootproto=static --device=bond-inner --ip=192.168.2.251 --netmask=255.255.255.    0 --		ipv6=auto --activate --bondslaves=ens3f3,ens3f2 --bondopts=downdelay=0,miimon=1,mode=    balance-		alb,updelay=0
> ```

- 屏幕行内移动
  - `g0`  移动到当前屏幕行的行首
    - `g^`  移动到当前屏幕行的第一个非空白字符
  - `g$`  移动到当前屏幕行的行尾
  - `gm`  移动到当前屏幕行的中间
- 屏幕行间移动
  - `gj`  移动到下一个屏幕行
  - `gk`  移动到上一个屏幕行
  - `H` `M` `L`  分别移动到<u>当前展示的所有屏幕行</u>中的L头部（head第一行的行首）、中间（middle中间一行的行首）和尾部（last最后一行的行首）



# 格式排版

- 自动对齐（格式化排版）
  - 选中内容对齐：可视模式或鼠标选中内容后按下`=`
  - 全文自动对齐：正常模式按下`gg=G`
- 排序`:sort`



# 文本编辑

本章节叙述的编辑操作为非插入模式下的操作，如无特别说明，以下vim命令均在normal模式进行。

进入插入模式，参看[vim-modes](vim-modes.md)。



可编辑动作组合的关键字：

- `w`  单词（word），以特定字符分隔的字符串
  - `aw`   around word会包含单词前的空白字符
  - `iw`   inner word只包含单词本身



## 选择

- 选择模式visual mode参看[vim-modes](vim-modes.md)。
  - `viw`和`vaw`  选择单词



## 查找

在全文中查找，如有匹配项，光标会跳转到第一个匹配向上，可使用`n`/`N`跳转下一个/上一个匹配项。

- `*`  查找光标所在的单词（继续使用`*`会跳转到下一个匹配项）

- 输入内容并查找

  以当前光标所在位置为界，如查找成功，会移动光标到当前位置前一个或后一个匹配项上。

  - `/`   向前查找（光标右侧为前）
  - `?`   向后查找（光标左侧为后）

  

## 替换

在命令行模式中使用，

```shell
#:[scope]s/<pattern>/<replace>/[flag]
:s/pattern/replace/g              #当前行 中查找和替换
:1,10 s/<pattern>/<replace>/g     #1到10行 中查找和替换
:,+5s/pattern/replace/g           #后5行 中查找和替换
:%s/pattern/replace/g             #全文 中查找和替换
:%s//replace/g                    #全文 中替换上一次的匹配项
```



### 大小写转换

1. visual模式选中内容
2. 按下
   - <kbd>u</kbd> 选中内容中的大写转为小
   - <kbd>shift</kbd><kbd>u</kbd> 选中内容中的小写转为大写



## 删除

- 全文删除 `ggdG` 或 `Gdgg`

- 行删除

  - 删除整行 `dd`

  - 从当前位置删除到行首：`d0`和`d^`

  - 从当前位置删除到行尾`d$`或`D`(即`⇧`+`d`)

    

- 单词删除

  - 删除当前单词`dw`
  - `de` 从当前位置删除至单词末尾
  - `daw` 和`diw`删除单词，包含空格 delete around word




## 修改

- `r`  进入替换模式，替换完一个字符并恢复为普通模式

  -  `R`  一直处于替换模式除非按下`Esc`

- `c`  change 执行某个修改操作并进入插入模式

  - `cw`  修改单词change word

  - `caw`  修改单词，包括空白符 

  - `C`  删除当前字符到行尾所有字符并进入插入模式

  - `ci{char}`  删除成对的两个char字符之间的内容并进入编辑模式（多行也适用）

    例如：`aa[bbbbb]cccc`，执行`ci[`将删除`[]`内的内容

    例如：

    > {
    >
    > "a":123,
    >
    > "b":456
    >
    > }

    执行`ci{`将删除`{}`之间的内容。

- `s`  修改谋个字符substitute 删除当前字符并进入插入模式

  - `S`  修改一行，删除本行并进入插入模式
  - 数字n+`s` 删除n个字符并进入插入模式
  



## 重复和撤销

在普通模式下：

- `.`  重复上一次操作
- `u`  撤销(undo)上一次操作



## 字符增减

在普通模式下，以下按键会对当前光标所在字符进行自动增减替换

- <kbd>Ctrl</kbd><kbd>x</kbd>  减
- <kbd>Ctrl</kbd><kbd>a</kbd>  加

`nrformats`的值确定哪些类型的字符可增减，默认值为`bin,hex,octal`，取值说明：

|          | 选项值 | `CTRL-X` | 原始值 | `CTRL-A` | 说明                   |
| -------- | ------ | -------- | ------ | -------- | ---------------------- |
| 十进制   |        | -1       | 0      | 2        | 以1-9开头的数值        |
| 二进制   | bin    | 0b0111   | 0b1000 | 0b1001   | 以"0b"或"0B"开头的数值 |
| 八进制   | octal  | 006      | 007    | 010      | 以0开头的数值          |
| 十六进制 | hex    | 0x0ff    | 0x100  | 0x101    | 以"0x"或"0X"开头的数值 |
| 字母     | alpha  | B        | C      | D        |                        |

- 对于字母
  - 对第一个字母"A"执行<kbd>Ctrl</kbd><kbd>x</kbd>  无作用
  - 对最后一个字母"Z"执行<kbd>Ctrl</kbd><kbd>a</kbd>无作用。

- 对于数字

  默认支持的数字进制为八进制和十六进制，如果一个数字为`007`，光标在`7`上，按下<kbd>Ctrl</kbd><kbd>a</kbd> ，数字将变为`010`。

  如果要默认将数字当作十进制处理，需要设置`set nrformats=` （等号后面不填写任何值，该设置下对字母也无法进行增减操作）。

- 累加累减操作

  可以在增加按键前输入数字表示重复操作，作用是进行指定次数的增减。

  例如当前光标在数字1上，按下`100`，再按下<kbd>Ctrl</kbd><kbd>a</kbd>，数字`1`将累加100次变成`101`



## 多行编辑

### 编辑多行的同一区块

1. <kbd>Ctrl</kbd><kbd>v</kbd>配合方向键/定位键等（如`G`、`$`）选中区块
2. 根据不同的修改需求选择

   - 替换：

     1. `r`

     2. 输入替换内容后直接完成替换
   - 插入：
   
     1. 根据不同的需求选择
        - 在区块前面插入：`I `
        - 在区块后面追加：`A`
        - 在长短不一的行尾插入
          1. 先`$`扩大选区至行尾
          2. `A`进入追加插入模式
     2. 输入要插入的内容（这时候光标在区块所有行中的第一行）
     3. <kbd>Esc</kbd>退出编辑模式
     4. 再次<kbd>Esc</kbd>，新插入内容将应用到所有行



### 多行注释示例

以`#`为注释符号为例。 

- 选中要修改的行，按下`:` ，输入指令`normal I#`。
- 选中要修改的行，按下`:` ，输入指令`s/^/#/`。
- 使用[编辑多行的同一区块](#编辑多行的同一区块)的方法
- 使用[宏](#宏)：录制宏a，内容为`I#`，选择需要注释的行回放该宏，或者执行执行:`m,n normal @a`。



# 寄存器

## 寄存器分类

Vim 支持的寄存器非常多，可使用命令`:reg` 查看所有寄存器及其内容或`:reg [register_name]` 查看指定寄存器(register_name)的内容。

部分寄存器如下：

- 未命名寄存器：`""` ，vim 的默认寄存器

  例如`y`，`x`、`dd`等操作的内容都会被保存到这里（每次操作后新内容将覆盖旧内容）。

- 系统剪切板寄存器

  需要vim支持clipboard功能，执行`vim --version|grep +clipboard`查看当前vim是否支持该功能，如不支持可安装其他版本的vim如gvim。

  - `"+` 剪切板寄存器，映射系统剪切板，保存在这个寄存器中的内容可以被系统其他程序访问

  - `"*`  映射系统剪切板。

    在X11下，其专用为鼠标选中内容寄存器，存储图形界面中鼠标框选的内容，在windows和macos系统下， `*` 和`+` 相同。

- 用户寄存器：`"a`-`"z` `"A`-`"Z`   vim不会读写，留给用户指定使用.
- 数字寄存器：`"0`-`"9` ， Vim 用来保存最近复制、删除等操作的10次内容， 0 号寄存器保存的是最近一次的操作内容。
- 只读寄存器：`"%`  存储了当前编辑的文件的名字
- 只读寄存器：`"#`



## 复制粘贴

- `yiw` `yaw`   复制单词

- 粘贴内容缩进混乱问题

  可使用这些方法：

  - 使用`"+p`粘贴
  - 设置 paste后粘贴
    1. normal模式下执行`:set paste`
    2. insert模式下粘贴内容
    3. normal模式下执行`:set nopaste` 恢复行为

- `"ayy`   复制当前行到寄存器 a

- `"ap`   粘贴寄存器 a 中的内容

- `"%p`  粘贴寄存器`%`内容



## vim中操作系统剪切板

可在normal或visual模式执行。

指令由寄存器名字和编辑命令（`y` `p`等）组成，如`"%p`：`"%`为寄存器名字，`p`为粘贴命令（粘贴寄存器`%`的内容），例如：

- `"+y`  复制选中内容到系统剪切板
  
  - `"+yy`  复制当前行
  - `gg"+yG`  复制全文
  
  `x` `dd`同理，剪切对应内容到系统剪切板
- `"+p`    将剪切板内容粘贴到光标后面

`"*p`同理。

技巧：在vim中`:set clipboard^=unnamed`，执行`y` `dd` `x` `p`就可以将复制/剪切到内容发送到系统剪切版内，使用vim命令`: 'clipboard'`查看相关说明。或者在`~/.vimrc`中添加以下内容以使其总是生效：

```shell
set clipboard^=unnamed
```

# 宏

一系列命令的集合。先录制，然后回放。

- 录制

  - 开始：在normal模式下，执行`q<register>` ，将宏保存到指定寄存器

    `<register>`表示必须给定的寄存器名字，例如任意一个用户寄存器，如qa

  - 录制指令：执行各种vim操作即可

  - 结束：在normal模式中执行`q`

  *qa --> 按下各种指令 -->q*

- 回放

  在指定行回放宏，可以：在normal模式执行`@<register>` 或者在命令中执行`:normal @<register>`。
  
  例如执行`@a`播放存储在a中的宏。
  
  重复播放可使用`.@a`，指定重复次数如`10@a`，也可使用v模式选中多行后在命令中执行回放操作。



# 补全

在编辑状态下`C-`表示按下<kbd>Ctrl</kbd>加其他按键。

- `C-n` 或`C-p`  普通关键字（n上一个 p下一个从提供当前文件中的关键词）

- `C-x C-n`  当前缓冲区关键字

- `C-x C-f`  文件名补全

- `C-x C-i`  包含文件关键字

- `C-x C-]`  标签文件关键字

- `C-x C-k`  字典查找

- `C-x C-o`  全能(Omni)补全

  

# 插件

插件管理器vim-plug、vundle等。

安装完插件管理器后，根据不同插件管理器的要求在`.vimrc`中定义要安装的插件。

相关站点：

- [vim-plug](https://github.com/junegunn/vim-plug) 插件管理器

- [vimawesiom](https://vimawesome.com/)



# shell中执行vim命令

shell中使用`vim -c`执行命令。  

> ```shell
> -> % cat /tmp/x
> #1
> #2
> #3
> -> % vim -c "%s/^#//" -c "wq" /tmp/x
> -> % cat /tmp/x
> 1
> 2
> 3
> ```



# 命令模式技巧

- `%`代指当前文件

- `:w !sudo tee %`  使用sudo将当前编辑内容作为stdin写入当前文件

  其等同于shell命令的`echo ${文件_Buff} | sudo tee ${文件名} `

- 插入当前文件名`:r! echo %`

- 插入当前文件绝对路径`:r! echo %:p`